#!/bin/bash
################################################################################
# Enhanced Log Collector - High Performance Configuration
# Author: Yash Shrivastava
# Copyright: Â© 2026 Yash Shrivastava
# License: MIT
# Version: 2.0.0
# Environment: High-Performance Production
# Use Case: Large-scale, high-volume logging scenarios
################################################################################

# ==============================================================================
# BASE CONFIGURATION
# ==============================================================================

BASE_LOG_DIR="/var/log"
DEFAULT_OWNER="postgres:postgres"
SCRIPT_VERSION="2.0.0"

# ==============================================================================
# LOG ROTATION SETTINGS
# ==============================================================================

# Larger files to reduce rotation frequency
MAX_LOG_SIZE_MB=500

# Shorter retention to manage disk space
LOG_RETENTION_DAYS=7
ARCHIVE_RETENTION_DAYS=30

# Maximum compression for space savings
ENABLE_COMPRESSION=true
COMPRESSION_LEVEL=9

# ==============================================================================
# OUTPUT FORMAT SETTINGS
# ==============================================================================

# Plain text is fastest
DEFAULT_OUTPUT_FORMAT="plain"

# Disable JSON by default (slower)
ENABLE_JSON_FORMAT=false

# No console output (overhead)
ENABLE_CONSOLE_OUTPUT=false

# Syslog enabled for centralized logging
ENABLE_SYSLOG=true
SYSLOG_FACILITY="local0"

# Remote syslog for offloading
SYSLOG_SERVER="syslog-collector.company.com:514"

# ==============================================================================
# EMAIL ALERT SETTINGS
# ==============================================================================

# Only critical alerts to reduce overhead
ENABLE_EMAIL_ALERTS=true
ALERT_EMAIL="critical-alerts@company.com"

# Only FATAL events
ALERT_LEVELS="FATAL"

EMAIL_SUBJECT_PREFIX="[CRITICAL]"
EMAIL_FROM="logcollector@production.company.com"
SMTP_SERVER="smtp.company.com"
SMTP_PORT=25

# ==============================================================================
# PERFORMANCE SETTINGS
# ==============================================================================

# All async operations enabled
ASYNC_COMPRESSION=true

# Aggressive caching
ENABLE_SIZE_CACHE=true
SIZE_CACHE_TIMEOUT=120

# More compression workers
MAX_COMPRESSION_JOBS=8

# ==============================================================================
# RATE LIMITING
# ==============================================================================

# Essential for high-volume scenarios
ENABLE_RATE_LIMIT=true

# High limits but still protective
RATE_LIMIT_MAX=50000
RATE_LIMIT_WINDOW=60

# Sample when limit reached
RATE_LIMIT_ACTION="sample"

# ==============================================================================
# LOG SAMPLING
# ==============================================================================

# Enable aggressive sampling for INFO/DEBUG
ENABLE_SAMPLING=true

# Log only 10% of low-priority messages
SAMPLE_RATE=10

# Never sample errors
SAMPLE_EXEMPT_LEVELS="ERROR,CRITICAL,FATAL"

# ==============================================================================
# RETENTION POLICIES BY LOG LEVEL
# ==============================================================================

# Aggressive cleanup for low-priority logs
DEBUG_RETENTION_DAYS=1
INFO_RETENTION_DAYS=3
NOTICE_RETENTION_DAYS=7
WARNING_RETENTION_DAYS=14
ERROR_RETENTION_DAYS=30
CRITICAL_RETENTION_DAYS=60
FATAL_RETENTION_DAYS=180

# ==============================================================================
# SECURITY SETTINGS
# ==============================================================================

LOG_FILE_PERMISSIONS=640
LOG_DIR_PERMISSIONS=750
VALIDATE_CONFIG_PERMISSIONS=true
SANITIZE_INPUT=true

# Limit message size to prevent memory issues
MAX_TASK_NAME_LENGTH=50
MAX_MESSAGE_LENGTH=8192

# ==============================================================================
# MONITORING & HEALTH
# ==============================================================================

ENABLE_HEALTH_CHECK=true
HEALTH_CHECK_FILE="/dev/shm/logCollector.health"  # RAM disk for speed
HEALTH_CHECK_INTERVAL=30

ENABLE_METRICS=true
METRICS_FILE="/dev/shm/logCollector_metrics.txt"  # RAM disk
METRICS_INTERVAL=60

# ==============================================================================
# STORAGE MANAGEMENT
# ==============================================================================

# Higher threshold before taking action
MIN_FREE_DISK_MB=5120  # 5GB minimum
DISK_WARNING_THRESHOLD=85
DISK_CRITICAL_THRESHOLD=95

# Aggressive cleanup when critical
DISK_CRITICAL_ACTION="cleanup"

# ==============================================================================
# ADVANCED FEATURES
# ==============================================================================

# Streaming enabled for real-time monitoring
ENABLE_LOG_STREAMING=true
LOG_STREAM_SOCKET="/dev/shm/logCollector.sock"  # RAM disk

# Structured logging optional
ENABLE_STRUCTURED_LOGGING=false

# Stack traces only for FATAL
INCLUDE_STACK_TRACES=false
MAX_STACK_TRACE_DEPTH=5

# ==============================================================================
# INTEGRATION SETTINGS
# ==============================================================================

# Direct integration with log aggregation
ENABLE_ELASTICSEARCH=true
ELASTICSEARCH_HOST="es-cluster.company.com"
ELASTICSEARCH_PORT=9200
ELASTICSEARCH_INDEX="logcollector-prod"

# Bulk insert for performance
ELASTICSEARCH_BULK_SIZE=1000
ELASTICSEARCH_BULK_TIMEOUT=30

ENABLE_SPLUNK=false
SPLUNK_HOST=""
SPLUNK_PORT=8088
SPLUNK_TOKEN=""

ENABLE_DATADOG=false
DATADOG_API_KEY=""
DATADOG_SITE="datadoghq.com"

# ==============================================================================
# DEBUGGING
# ==============================================================================

# No debugging overhead
DEBUG_MODE=false
DEBUG_LOG_FILE="/dev/null"
LOG_CONFIG_ON_STARTUP=false

# ==============================================================================
# CLEANUP SETTINGS
# ==============================================================================

# Very aggressive cleanup
CLEANUP_CHECK_PROBABILITY=20
CLEANUP_SCHEDULE="0 */6 * * *"  # Every 6 hours
TEMP_FILE_MAX_AGE=0  # Immediate cleanup

# ==============================================================================
# CUSTOM METADATA
# ==============================================================================

# Minimal metadata to reduce overhead
CUSTOM_METADATA_ENABLED=true
METADATA_ENVIRONMENT="production"
METADATA_VERSION="$SCRIPT_VERSION"

# ==============================================================================
# TIMEZONE
# ==============================================================================

LOG_TIMEZONE="UTC"
TIMESTAMP_FORMAT="unix"  # Fastest format
CUSTOM_TIMESTAMP_FORMAT=""

# ==============================================================================
# HIGH-PERFORMANCE SPECIFIC SETTINGS
# ==============================================================================

# Use faster hashing for file tracking
USE_FAST_HASH=true

# Buffer size for file operations (bytes)
FILE_BUFFER_SIZE=65536

# Disable fsync for better performance (less durability)
DISABLE_FSYNC=false

# Use memory-mapped files for large logs
USE_MMAP=true

# Pre-allocate log files
PREALLOCATE_FILES=true

# Preallocate size (MB)
PREALLOCATE_SIZE=100

# Batch writes
ENABLE_BATCH_WRITES=true

# Batch size (number of log entries)
BATCH_SIZE=100

# Batch timeout (seconds)
BATCH_TIMEOUT=1

# Enable lock-free operations where possible
ENABLE_LOCKFREE=true

# I/O scheduler hints
IO_SCHEDULER="noop"

# Nice level for compression jobs
COMPRESSION_NICE_LEVEL=19

# CPU affinity for log collector process
CPU_AFFINITY=""  # Leave empty for no affinity

# Memory limit for script (MB)
MEMORY_LIMIT=1024

# ==============================================================================
# TUNING PARAMETERS
# ==============================================================================

# Maximum open files
MAX_OPEN_FILES=65535

# Socket buffer sizes (bytes)
SOCKET_BUFFER_SIZE=262144

# Enable kernel AIO
USE_KERNEL_AIO=false

# Direct I/O for large files
USE_DIRECT_IO=false

# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================
