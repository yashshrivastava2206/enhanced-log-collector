#!/bin/bash
################################################################################
# Enhanced Log Collector - Docker/Container Configuration
# Author: Yash Shrivastava
# Copyright: Â© 2026 Yash Shrivastava
# License: MIT
# Version: 2.0.0
# Environment: Docker/Kubernetes/Container
################################################################################

# ==============================================================================
# BASE CONFIGURATION
# ==============================================================================

# Container-optimized paths
BASE_LOG_DIR="/var/log/app"
DEFAULT_OWNER="app:app"
SCRIPT_VERSION="2.0.0"

# ==============================================================================
# LOG ROTATION SETTINGS
# ==============================================================================

# Smaller files for containers
MAX_LOG_SIZE_MB=25

# Shorter retention (logs shipped externally)
LOG_RETENTION_DAYS=1
ARCHIVE_RETENTION_DAYS=3

# Quick compression
ENABLE_COMPRESSION=true
COMPRESSION_LEVEL=3  # Fast compression

# ==============================================================================
# OUTPUT FORMAT SETTINGS
# ==============================================================================

# JSON for log aggregation
DEFAULT_OUTPUT_FORMAT="json"
ENABLE_JSON_FORMAT=true

# Console output for container logs (docker logs)
ENABLE_CONSOLE_OUTPUT=true

# No local syslog in containers
ENABLE_SYSLOG=false
SYSLOG_FACILITY="local0"

# Remote syslog via network
SYSLOG_SERVER="${SYSLOG_HOST:-syslog.default.svc.cluster.local}:514"

# ==============================================================================
# EMAIL ALERT SETTINGS
# ==============================================================================

# Email not typically used in containers
ENABLE_EMAIL_ALERTS="${ENABLE_ALERTS:-false}"
ALERT_EMAIL="${ALERT_EMAIL:-alerts@company.com}"
ALERT_LEVELS="FATAL,CRITICAL"

EMAIL_SUBJECT_PREFIX="[CONTAINER-LOG]"
EMAIL_FROM="logcollector@container"
SMTP_SERVER="${SMTP_HOST:-}"
SMTP_PORT="${SMTP_PORT:-25}"

# ==============================================================================
# PERFORMANCE SETTINGS
# ==============================================================================

# Async operations suitable for containers
ASYNC_COMPRESSION=true
ENABLE_SIZE_CACHE=true
SIZE_CACHE_TIMEOUT=30
MAX_COMPRESSION_JOBS=2

# ==============================================================================
# RATE LIMITING
# ==============================================================================

# Enabled to prevent log storms
ENABLE_RATE_LIMIT=true
RATE_LIMIT_MAX=10000
RATE_LIMIT_WINDOW=60
RATE_LIMIT_ACTION="sample"

# ==============================================================================
# LOG SAMPLING
# ==============================================================================

# Optional sampling based on environment
ENABLE_SAMPLING="${ENABLE_SAMPLING:-false}"
SAMPLE_RATE="${SAMPLE_RATE:-100}"
SAMPLE_EXEMPT_LEVELS="ERROR,CRITICAL,FATAL"

# ==============================================================================
# RETENTION POLICIES BY LOG LEVEL
# ==============================================================================

# Very short retention (offloaded to external systems)
DEBUG_RETENTION_DAYS=1
INFO_RETENTION_DAYS=1
NOTICE_RETENTION_DAYS=1
WARNING_RETENTION_DAYS=2
ERROR_RETENTION_DAYS=3
CRITICAL_RETENTION_DAYS=7
FATAL_RETENTION_DAYS=7

# ==============================================================================
# SECURITY SETTINGS
# ==============================================================================

# Relaxed for containers (ephemeral)
LOG_FILE_PERMISSIONS=644
LOG_DIR_PERMISSIONS=755

VALIDATE_CONFIG_PERMISSIONS=false
SANITIZE_INPUT=true
MAX_TASK_NAME_LENGTH=100
MAX_MESSAGE_LENGTH=32768

# ==============================================================================
# MONITORING & HEALTH
# ==============================================================================

# Health checks for container orchestration
ENABLE_HEALTH_CHECK=true
HEALTH_CHECK_FILE="/tmp/logCollector.health"
HEALTH_CHECK_INTERVAL=30

ENABLE_METRICS=true
METRICS_FILE="/tmp/logCollector_metrics.txt"
METRICS_INTERVAL=60

# ==============================================================================
# STORAGE MANAGEMENT
# ==============================================================================

# Lower thresholds for container volumes
MIN_FREE_DISK_MB=100
DISK_WARNING_THRESHOLD=70
DISK_CRITICAL_THRESHOLD=85
DISK_CRITICAL_ACTION="cleanup"

# ==============================================================================
# ADVANCED FEATURES
# ==============================================================================

# Streaming suitable for sidecar pattern
ENABLE_LOG_STREAMING=true
LOG_STREAM_SOCKET="/tmp/logCollector.sock"

# Structured logging essential for containers
ENABLE_STRUCTURED_LOGGING=true
INCLUDE_STACK_TRACES=true
MAX_STACK_TRACE_DEPTH=10

# ==============================================================================
# INTEGRATION SETTINGS
# ==============================================================================

# Elasticsearch common in container environments
ENABLE_ELASTICSEARCH="${ENABLE_ELASTICSEARCH:-false}"
ELASTICSEARCH_HOST="${ELASTICSEARCH_HOST:-elasticsearch.default.svc.cluster.local}"
ELASTICSEARCH_PORT="${ELASTICSEARCH_PORT:-9200}"
ELASTICSEARCH_INDEX="${ELASTICSEARCH_INDEX:-logcollector}"

ENABLE_SPLUNK="${ENABLE_SPLUNK:-false}"
SPLUNK_HOST="${SPLUNK_HOST:-}"
SPLUNK_PORT="${SPLUNK_PORT:-8088}"
SPLUNK_TOKEN="${SPLUNK_TOKEN:-}"

ENABLE_DATADOG="${ENABLE_DATADOG:-false}"
DATADOG_API_KEY="${DATADOG_API_KEY:-}"
DATADOG_SITE="${DATADOG_SITE:-datadoghq.com}"

# Fluentd integration (common in K8s)
ENABLE_FLUENTD="${ENABLE_FLUENTD:-false}"
FLUENTD_HOST="${FLUENTD_HOST:-fluentd.default.svc.cluster.local}"
FLUENTD_PORT="${FLUENTD_PORT:-24224}"

# ==============================================================================
# DEBUGGING
# ==============================================================================

# Controlled by environment variable
DEBUG_MODE="${DEBUG_MODE:-false}"
DEBUG_LOG_FILE="/tmp/logCollector_debug.log"
LOG_CONFIG_ON_STARTUP="${LOG_CONFIG_ON_STARTUP:-true}"

# ==============================================================================
# CLEANUP SETTINGS
# ==============================================================================

# Aggressive cleanup for limited container storage
CLEANUP_CHECK_PROBABILITY=50
CLEANUP_SCHEDULE=""  # No cron in containers
TEMP_FILE_MAX_AGE=0

# ==============================================================================
# CUSTOM METADATA
# ==============================================================================

# Rich metadata from container environment
CUSTOM_METADATA_ENABLED=true
METADATA_ENVIRONMENT="${ENVIRONMENT:-production}"
METADATA_DATACENTER="${DATACENTER:-cloud}"
METADATA_VERSION="$SCRIPT_VERSION"

# Kubernetes-specific metadata
METADATA_NAMESPACE="${KUBERNETES_NAMESPACE:-default}"
METADATA_POD_NAME="${HOSTNAME:-unknown}"
METADATA_POD_IP="${POD_IP:-}"
METADATA_NODE_NAME="${NODE_NAME:-}"
METADATA_SERVICE_ACCOUNT="${SERVICE_ACCOUNT:-default}"

# Container-specific metadata
METADATA_CONTAINER_ID="${CONTAINER_ID:-}"
METADATA_CONTAINER_NAME="${CONTAINER_NAME:-}"
METADATA_IMAGE_NAME="${IMAGE_NAME:-}"
METADATA_IMAGE_TAG="${IMAGE_TAG:-latest}"

# ==============================================================================
# TIMEZONE
# ==============================================================================

# UTC standard for containers
LOG_TIMEZONE="UTC"
TIMESTAMP_FORMAT="iso8601"
CUSTOM_TIMESTAMP_FORMAT="%Y-%m-%dT%H:%M:%S.%3NZ"

# ==============================================================================
# CONTAINER-SPECIFIC SETTINGS
# ==============================================================================

# Use stdout/stderr for container logs
ENABLE_STDOUT_LOGGING=true

# Include container runtime metadata
INCLUDE_CONTAINER_METADATA=true

# Follow container lifecycle
FOLLOW_CONTAINER_LIFECYCLE=true

# Graceful shutdown timeout (seconds)
SHUTDOWN_TIMEOUT=30

# Signal handling for container stop
HANDLE_SIGTERM=true
HANDLE_SIGINT=true

# Resource limits
MEMORY_LIMIT_MB=512
CPU_LIMIT_CORES=1

# ==============================================================================
# KUBERNETES-SPECIFIC SETTINGS
# ==============================================================================

# Service mesh integration
ENABLE_SERVICE_MESH="${ENABLE_SERVICE_MESH:-false}"
SERVICE_MESH_TYPE="${SERVICE_MESH_TYPE:-istio}"

# Kubernetes labels as metadata
INCLUDE_K8S_LABELS=true

# Kubernetes annotations as metadata
INCLUDE_K8S_ANNOTATIONS=false

# Probe endpoints
LIVENESS_PROBE_ENABLED=true
LIVENESS_PROBE_PORT=8080
LIVENESS_PROBE_PATH="/health/live"

READINESS_PROBE_ENABLED=true
READINESS_PROBE_PORT=8080
READINESS_PROBE_PATH="/health/ready"

# ==============================================================================
# CLOUD PROVIDER SETTINGS
# ==============================================================================

# AWS-specific
AWS_REGION="${AWS_REGION:-}"
AWS_ACCOUNT_ID="${AWS_ACCOUNT_ID:-}"
ENABLE_CLOUDWATCH="${ENABLE_CLOUDWATCH:-false}"
CLOUDWATCH_LOG_GROUP="${CLOUDWATCH_LOG_GROUP:-/aws/container/logcollector}"
CLOUDWATCH_LOG_STREAM="${CLOUDWATCH_LOG_STREAM:-${HOSTNAME}}"

# GCP-specific
GCP_PROJECT_ID="${GCP_PROJECT_ID:-}"
GCP_ZONE="${GCP_ZONE:-}"
ENABLE_STACKDRIVER="${ENABLE_STACKDRIVER:-false}"

# Azure-specific
AZURE_SUBSCRIPTION_ID="${AZURE_SUBSCRIPTION_ID:-}"
AZURE_RESOURCE_GROUP="${AZURE_RESOURCE_GROUP:-}"
ENABLE_AZURE_MONITOR="${ENABLE_AZURE_MONITOR:-false}"

# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================
