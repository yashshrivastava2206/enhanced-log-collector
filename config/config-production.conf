#!/bin/bash
################################################################################
# Enhanced Log Collector - Production Configuration
# Author: Yash Shrivastava
# Copyright: Â© 2026 Yash Shrivastava
# License: MIT
# Version: 2.0.0
# Environment: Production
################################################################################

# ==============================================================================
# BASE CONFIGURATION
# ==============================================================================

# Root directory for all log files
BASE_LOG_DIR="/var/log"

# Default file ownership (user:group)
DEFAULT_OWNER="postgres:postgres"

# Script version identifier
SCRIPT_VERSION="2.0.0"

# ==============================================================================
# LOG ROTATION SETTINGS
# ==============================================================================

# Maximum size for a single log file before rotation (in MB)
# When a log file reaches this size, it will be rotated to archive
MAX_LOG_SIZE_MB=100

# Number of days to keep uncompressed log files
# After this period, logs are moved to archive and compressed
LOG_RETENTION_DAYS=30

# Number of days to keep compressed archive files
# After this period, archived logs are permanently deleted
ARCHIVE_RETENTION_DAYS=90

# Enable automatic compression of rotated logs
# Options: true, false
ENABLE_COMPRESSION=true

# Compression level (1-9, where 9 is maximum compression)
# Higher values = better compression but slower
COMPRESSION_LEVEL=6

# ==============================================================================
# OUTPUT FORMAT SETTINGS
# ==============================================================================

# Default output format for log entries
# Options: plain, json, syslog
DEFAULT_OUTPUT_FORMAT="plain"

# Enable JSON format output by default
# Can be overridden per log call with --json flag
ENABLE_JSON_FORMAT=false

# Enable console output by default
# Can be overridden per log call with --console flag
ENABLE_CONSOLE_OUTPUT=false

# Enable syslog integration by default
# Can be overridden per log call with --syslog flag
ENABLE_SYSLOG=true

# Syslog facility to use
# Options: local0-local7, user, daemon, etc.
SYSLOG_FACILITY="local0"

# Syslog server (for remote logging)
# Leave empty for local syslog only
# Format: hostname:port or ip:port
SYSLOG_SERVER=""

# ==============================================================================
# EMAIL ALERT SETTINGS
# ==============================================================================

# Enable email notifications for critical events
ENABLE_EMAIL_ALERTS=true

# Email address to receive alerts
# Can be comma-separated for multiple recipients
ALERT_EMAIL="dba-oncall@company.com,sre-team@company.com"

# Log levels that trigger email alerts (comma-separated)
# Options: DEBUG, INFO, NOTICE, WARNING, ERROR, CRITICAL, FATAL
ALERT_LEVELS="FATAL,CRITICAL"

# Email subject prefix
EMAIL_SUBJECT_PREFIX="[PROD-LOG-ALERT]"

# Email from address
EMAIL_FROM="logcollector@production.company.com"

# SMTP server (leave empty to use system mail)
SMTP_SERVER=""

# SMTP port (default: 25)
SMTP_PORT=25

# ==============================================================================
# PERFORMANCE SETTINGS
# ==============================================================================

# Enable async compression (compress in background)
ASYNC_COMPRESSION=true

# Enable file size caching to reduce stat() calls
ENABLE_SIZE_CACHE=true

# Cache timeout in seconds
SIZE_CACHE_TIMEOUT=60

# Maximum number of concurrent compression jobs
MAX_COMPRESSION_JOBS=4

# ==============================================================================
# RATE LIMITING
# ==============================================================================

# Enable rate limiting to prevent log flooding
ENABLE_RATE_LIMIT=true

# Maximum logs per time window
RATE_LIMIT_MAX=10000

# Time window for rate limiting (in seconds)
RATE_LIMIT_WINDOW=60

# Action when rate limit exceeded
# Options: drop (discard logs), sample (log every Nth), block (wait)
RATE_LIMIT_ACTION="sample"

# ==============================================================================
# LOG SAMPLING
# ==============================================================================

# Enable log sampling for high-volume scenarios
ENABLE_SAMPLING=false

# Sample rate percentage (0-100)
# 100 = log everything, 50 = log 50%, 10 = log 10%
SAMPLE_RATE=100

# Levels exempt from sampling (always logged)
SAMPLE_EXEMPT_LEVELS="ERROR,CRITICAL,FATAL"

# ==============================================================================
# RETENTION POLICIES BY LOG LEVEL
# ==============================================================================

# Override retention for specific log levels
# Format: LEVEL_RETENTION_DAYS
DEBUG_RETENTION_DAYS=7
INFO_RETENTION_DAYS=30
NOTICE_RETENTION_DAYS=30
WARNING_RETENTION_DAYS=60
ERROR_RETENTION_DAYS=90
CRITICAL_RETENTION_DAYS=180
FATAL_RETENTION_DAYS=365

# ==============================================================================
# SECURITY SETTINGS
# ==============================================================================

# File permissions for new log files (octal)
LOG_FILE_PERMISSIONS=640

# Directory permissions for new log directories (octal)
LOG_DIR_PERMISSIONS=750

# Validate config file permissions on startup
VALIDATE_CONFIG_PERMISSIONS=true

# Sanitize all input (recommended: true)
SANITIZE_INPUT=true

# Maximum length for task names
MAX_TASK_NAME_LENGTH=100

# Maximum length for log messages
MAX_MESSAGE_LENGTH=65536

# ==============================================================================
# MONITORING & HEALTH
# ==============================================================================

# Enable health check file
ENABLE_HEALTH_CHECK=true

# Health check file location
HEALTH_CHECK_FILE="/var/run/logCollector.health"

# Health check update interval (seconds)
HEALTH_CHECK_INTERVAL=60

# Enable metrics collection
ENABLE_METRICS=true

# Metrics file location
METRICS_FILE="/var/log/logCollector_metrics.txt"

# Metrics update interval (seconds)
METRICS_INTERVAL=300

# ==============================================================================
# STORAGE MANAGEMENT
# ==============================================================================

# Minimum required free disk space (MB)
MIN_FREE_DISK_MB=1024

# Warning threshold for disk usage (percentage)
DISK_WARNING_THRESHOLD=80

# Critical threshold for disk usage (percentage)
DISK_CRITICAL_THRESHOLD=90

# Action when disk space critical
# Options: alert (send alert only), stop (stop logging), cleanup (force cleanup)
DISK_CRITICAL_ACTION="cleanup"

# ==============================================================================
# ADVANCED FEATURES
# ==============================================================================

# Enable log streaming to socket
ENABLE_LOG_STREAMING=false

# Log stream socket path
LOG_STREAM_SOCKET="/var/run/logCollector.sock"

# Enable structured logging mode
ENABLE_STRUCTURED_LOGGING=false

# Include stack traces in error logs
INCLUDE_STACK_TRACES=true

# Maximum stack trace depth
MAX_STACK_TRACE_DEPTH=10

# ==============================================================================
# INTEGRATION SETTINGS
# ==============================================================================

# Elasticsearch integration
ENABLE_ELASTICSEARCH=false
ELASTICSEARCH_HOST=""
ELASTICSEARCH_PORT=9200
ELASTICSEARCH_INDEX="logcollector"

# Splunk integration
ENABLE_SPLUNK=false
SPLUNK_HOST=""
SPLUNK_PORT=8088
SPLUNK_TOKEN=""

# Datadog integration
ENABLE_DATADOG=false
DATADOG_API_KEY=""
DATADOG_SITE="datadoghq.com"

# ==============================================================================
# DEBUGGING
# ==============================================================================

# Enable debug mode (verbose output)
DEBUG_MODE=false

# Debug log file
DEBUG_LOG_FILE="/var/log/logCollector_debug.log"

# Log all configuration values on startup
LOG_CONFIG_ON_STARTUP=true

# ==============================================================================
# CLEANUP SETTINGS
# ==============================================================================

# Probability of running cleanup check (1-100%)
# Lower values reduce overhead but delay cleanup
CLEANUP_CHECK_PROBABILITY=1

# Force cleanup on specific schedule
# Format: cron-style (minute hour day month weekday)
# Leave empty to disable scheduled cleanup
CLEANUP_SCHEDULE="0 2 * * *"  # Daily at 2 AM

# Maximum age of temporary files (days)
TEMP_FILE_MAX_AGE=1

# ==============================================================================
# CUSTOM METADATA
# ==============================================================================

# Add custom metadata to all log entries
# Format: KEY=VALUE pairs
CUSTOM_METADATA_ENABLED=true

# Default metadata fields
METADATA_ENVIRONMENT="production"
METADATA_DATACENTER="us-east-1"
METADATA_CLUSTER="prod-db-cluster-01"
METADATA_VERSION="$SCRIPT_VERSION"

# ==============================================================================
# TIMEZONE
# ==============================================================================

# Timezone for timestamps
# Leave empty to use system timezone
LOG_TIMEZONE="UTC"

# Timestamp format
# Options: iso8601, rfc3339, unix, custom
TIMESTAMP_FORMAT="iso8601"

# Custom timestamp format (if TIMESTAMP_FORMAT=custom)
# Use date command format specifiers
CUSTOM_TIMESTAMP_FORMAT="%Y-%m-%d %H:%M:%S %z"

# ==============================================================================
# END OF CONFIGURATION
# ==============================================================================
